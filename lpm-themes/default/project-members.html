<?php
/* 
Требуются: 
    $project - проект
    $projectMembers - участники проекта
    $projectTester - Тестировщик по умолчанию
    $canEdit - может ли текущий участник редактировать
    $labels - теги в проекте
*/

$defaultIssueMember = null;
$memberByDefaultId = $project->defaultIssueMemberId;
if (!empty($memberByDefaultId)) {
    foreach ($projectMembers as $member) {
        if ($member->getID() === $memberByDefaultId) {
            $defaultIssueMember = $member;
            break;
        }
    }
}

$labelNameById = [];
foreach ($labels as $label) {
    $labelNameById[(int)$label['id']] = $label['label'];
}
?>
<article id="projectMembers" class="container">
    <h1>
        <?php lpm_print_header(); ?>
    </h1>
    <input type="hidden" name="projectId" value="<?=$project->getID();?>" />
    <div class="card my-3">
        <div class="card-header">Участники проекта</div>
        <div class="card-body">
            <div class="alert alert-success info-message" role="alert" style="display: none;">Сохранено</div>
            <ul class="list-group mb-3">
        <?php foreach ($projectMembers as $member): ?>
        <li class="list-group-item d-flex justify-content-between align-items-center">
            <span class="user-name"><?=$member->getLinkedName();?></span>
            <input id="userIdId" type="hidden" name="userId" value="<?=$member->getID();?>">
        </li>
        <?php endforeach; ?>
            </ul>

            <?php if ($canEdit): ?>
            <button
                class="btn btn-primary"
                onclick="openMembersChooser();">
                Добавить
            </button>
            <?php endif; ?>
        </div>
    </div>

    
    <div class="card my-3">
        <div class="card-header">PM проекта</div>
        <div class="card-body">
            <div id="projectPM" class="project-members-selector">
        <?php
        $pm = $project->getPM();
        if (!empty($pm)):
        ?>
        <ul class="list-group mb-0">
            <li class="list-group-item d-flex justify-content-between align-items-center" value="<?=$pm->getName();?>">
                <?=$pm->getName();?>
                <?php if ($canEdit): ?>
                <a href="javascript:;" id="removePM" class="remove-link link-secondary small">Удалить</a>
                <?php endif; ?>
            </li>
        </ul>
        <?php elseif ($canEdit): ?>
        <form id="choosePM" class="row row-cols-lg-auto g-3 align-items-center mb-0">
            <div class="col-12">
                <label class="visually-hidden" for="inlineFormSelectPref">PM</label>
                <select class="form-select" id="selectPM">
                    <option value="0">PM не выбран</option>
                    <?php foreach ($projectMembers as $member): ?>
                    <option class="user-name" value="<?=$member->getID();?>"><?=$member->getLinkedName();?></option>
                    <?php endforeach; ?>
                </select>
            </div>
            
            <div class="col-12">
                <button id="savePM" type="button" class="btn btn-primary">Подтвердить</button>
            </div>
        </form>
        <?php else: ?>
        <p>Не выбран</p>
        <?php endif; ?>
            </div>
        </div>
    </div>

    
    <div class="card my-3">
        <div class="card-header">Мастер проекта</div>
        <div class="card-body">
            <div id="projectMaster" class="project-members-selector">
        <h6 class="text-body-secondary">По умолчанию</h6>
        <?php
        $master = $project->getMaster();
        if (!empty($master)): 
        ?>
        <ul class="list-group mb-0">
            <li class="list-group-item d-flex justify-content-between align-items-center" id="projectMaster" value="<?=$master->getName();?>">
                <?=$master->getName();?>
                <?php if ($canEdit): ?>
                <a href="javascript:;" id="removeMaster" class="remove-link link-secondary small">Удалить</a>
                <?php endif; ?>
            </li>
        </ul>
        <?php elseif ($canEdit): ?>
        <form id="chooseMaster" class="row row-cols-lg-auto g-3 align-items-center mb-3">
            <div class="col-12">
                <label class="visually-hidden" for="inlineFormSelectPref">Мастер</label>
                <select class="form-select" id="selectMaster">
                    <option value="0">Мастер не выбран</option>
                    <?php foreach ($projectMembers as $member): ?>
                    <option class="user-name" value="<?=$member->getID();?>"><?=$member->getLinkedName();?></option>
                    <?php endforeach; ?>
                </select>
            </div>
            
            <div class="col-12">
                <button id="saveMaster" type="button" class="btn btn-primary">Подтвердить</button>
            </div>
        </form>
        <?php else: ?>
        <p>Не выбран</p>
        <?php endif; ?>

        <form id="specMasters" action="">
            <h6 class="text-body-secondary mt-3">Мастера по тегам</h6>
            <table class="table spec-master-list tags-users-list list-unstyled mb-3">
                <?php 
                foreach ($project->getSpecMasters() as $master): 
                    $labelName = empty($labelNameById[$master->extraId]) ? 'n/a' : $labelNameById[$master->extraId];
                ?>
                <tr class="spec-master-item" data-user-id="<?=$master->getID();?>" data-label-id="<?=$master->extraId;?>">
                    <td class="tag w-auto"><span class="badge bg-light text-secondary"><?=$labelName;?></span></td>
                    <td class="name w-100"><?=$master->getName();?></td>
                    <?php if ($canEdit): ?>
                    <td class="w-auto"><a href="javascript:;" class="actions remove-link link-secondary small mx-1 px-1">Удалить</a></td>
                    <?php endif; ?>
                </tr>
            <?php endforeach; ?>
            </table>

            <?php if ($canEdit): ?>
            <button
                type="button"
                onclick="addSpecMaster.show();"
                class="btn btn-primary">
                Добавить
            </button>
            <?php endif; ?>
        </form>
            </div>
        </div>
    </div>
    
    <div class="card my-3">
        <div class="card-header">Исполнитель задач по умолчанию</div>
        <div class="card-body">
            <div class="project-members-selector">
                <?php if (!empty($defaultIssueMember)): ?>
                <ul class="list-group mb-0">
                    <li class="list-group-item d-flex justify-content-between align-items-center" id="liNamePerformer" value="1"><?=$defaultIssueMember->getLinkedName(); ?>
                        <?php if ($canEdit): ?>
                        <a href="javascript:;" id="removeDefaultMember" class="remove-link link-secondary small">Удалить</a>
                        <?php endif; ?>
                    </li>
                </ul>
                <?php elseif ($canEdit): ?>
                <form id="divPerformer" class="row row-cols-lg-auto g-3 align-items-center mb-0" onsubmit="return false;">
                    <div class="col-12">
                        <label class="visually-hidden" for="inlineFormSelectPref">Исполнитель</label>
                        <select class="form-select" id="selectMember">
                            <option value="0">Исполнитель не выбран</option>
                            <?php foreach ($projectMembers as $member): ?>
                            <option class="user-name" value=" <?=$member->getID();?> "><?=$member->getLinkedName();?></option>
                            <?php endforeach; ?>
                        </select>
                    </div>
                    
                    <div class="col-12">
                        <button id="btnSelectMember" type="button" class="btn btn-primary">Подтвердить</button>
                    </div>
                </form>
                <?php else: ?>
                <p>Не выбран</p>
                <?php endif; ?>
            </div>
        </div>
    </div>

    
    <div class="card my-3">
        <div class="card-header">Тестировщик проекта</div>
        <div class="card-body">
            <div id="select-tester-option" class="project-members-selector">
                <h6 class="text-body-secondary">По умолчанию</h6>
                <?php if(!empty($projectTester)): ?>
                <ul class="list-group mb-0">
                    <li class="list-group-item d-flex justify-content-between align-items-center" id="NameTester" value="<?=$projectTester->getName();?>">
                        <?=$projectTester->getName();?>
                        <?php if ($canEdit): ?>
                        <a href="javascript:;" id="removeTester" class="remove-link link-secondary small">Удалить</a>
                        <?php endif; ?>
                    </li>
                </ul>
                <?php elseif ($canEdit): ?>
                <form id="formOption" class="row row-cols-lg-auto g-3 align-items-center mb-3" onsubmit="return false;">
                    <div class="col-12">
                        <label class="visually-hidden" for="inlineFormSelectPref">Тестировщик</label>
                        <select class="form-select" id="selectTester">
                            <option value="0">Тестер не выбран</option>
                            <?php foreach ($projectMembers as $member): ?>
                            <option class="user-name" value=" <?=$member->getID();?> "><?=$member->getLinkedName();?></option>
                            <?php endforeach; ?>
                        </select>
                    </div>
            
                    <div class="col-12">
                        <button id="btnSelect" type="button" class="btn btn-primary">Подтвердить</button>
                    </div>
                </form>
                <?php else: ?>
                <p>Не выбран</p>
                <?php endif; ?>
                <h6 class="text-body-secondary mt-3">Тестировщики по тегам</h6>
                <form id="specTesters" action="">
                    <table class="table spec-tester-list tags-users-list list-unstyled mb-3">
                        <?php 
                        foreach ($project->getSpecTesters() as $tester): 
                            $labelName = empty($labelNameById[$tester->extraId]) ? 'n/a' : $labelNameById[$tester->extraId];
                        ?>
                        <tr class="spec-tester-item" data-user-id="<?=$tester->getID();?>" data-label-id="<?=$tester->extraId;?>">
                            <td class="tag w-auto"><span class="badge bg-light text-secondary"><?=$labelName;?></span></td>
                            <td class="name w-100"><?=$tester->getName();?></td>
                            <?php if ($canEdit): ?>
                            <td class="w-auto"> <a href="javascript:;" class="actions remove-link link-secondary small mx-1 px-1">Удалить</a></td>
                            <?php endif; ?>
                        </tr>
                        <?php endforeach; ?>
                    </table>

                    <?php if ($canEdit): ?>
                    <button
                        type="button"
                        onclick="addSpecTester.show();"
                        class="btn btn-primary">
                        Добавить
                    </button>
                    <?php endif; ?>
                </form>
            </div>
        </div>
    <?php lpm_print_users_chooser();?>
    </div>
</article>

<article id="addSpecMember" title="Добавить участника по тегу" style="display: none;">
    <div class="row mb-3 add-spec-project-row">
        <label for="selectTagForSpecMember" class="col-sm-3 col-form-label">Тег</label>
        <div class="col-sm-9">
            <select class="form-select select-tag-for-spec-member" id="selectTagForSpecMember">
                <option value="0">-</option>
                <?php foreach ($labels as $label): ?>
                <option class="label-name" value=" <?=$label['id'];?> "><?=$label['label'];?></option>
                <?php endforeach; ?>
            </select>
        </div>
    </div>
    <div class="row mb-3 add-spec-project-row">
        <label for="selectSpecMember" class="col-sm-3 col-form-label select-spec-member-label">Участник</label>
        <div class="col-sm-9">
            <select class="form-select select-spec-member" id="selectSpecMember">
                <option value="0">-</option>
                <?php foreach ($projectMembers as $member): ?>
                <option class="user-name" value=" <?=$member->getID();?> "><?=$member->getLinkedName();?></option>
                <?php endforeach; ?>
            </select>
        </div>
    </div>
</article>
