<?php
/* 
Требуются: 
    $issue - текущая задача
*/
?><article id="issueView">  
  <h1><a href="<?=lpm_get_base_page_url();?>"><?lpm_print_header();?></a></h1>
  <div class="header-operations-bar">
    <a href="<?=$issue->getProjectUrl('add-issue');?>">Новая задача</a>
  </div>
  <!-- <p class="header-back-link"><a href="<?=lpm_get_base_page_url();?>" class="back-link">Назад</a></p> -->
  <article id="issueInfo" class="container">
    <h3>
        <span class="issue-id"><?=$issue->getIdInProject();?></span>.
		<span class="issue-name"><?=$issue->getName();?></span><?php if (($hours = $issue->hours) > 0): ?><span class="issues-hours-box">(<span class="issue-hours"><?=$issue->getStrHours();?></span>&nbsp;<?=$issue->getNormHoursLabel(false);?>)</span><?php endif;?>
        <?php if ($issue->getProject()->scrum && !$issue->isOnBoard()):?>
        <a href="#" onclick="return issuePage.putStickerOnBoard(<?=$issue->id;?>);" title="Поместить на Scrum доску" class="scrum-put-sticker"><i class="fa fa-thumbtack" aria-hidden="true"></i></a>
        <?php endif;?>
    </h3>     
    <div class="issue_copy">
        <a href="javascript:;" class="issue-commit-copy-link">скопировать commit сообщение</a>
    </div>
    <ol class="info-list <?switch($issue->status): 
    case 0: ?>active-issue <?break;?> 
    <? case 1: ?>verify-issue <?break;?> 
    <?case 2: ?>completed-issue<?break;?>
    <?endswitch;?>">
        <li>
            <span class="label">Статус</span>
            <span class="value"><?=$issue->getStatus();?></span>
        </li>
        <li>
            <span class="label">Тип</span>
            <span class="value"><?=$issue->getType();?></span>
            <input type="hidden" name="type" value="<?=$issue->type;?>"/>
        </li>
        <li>
            <span class="label">Приоритет</span>
            <span class="value">
                <span class="priority-val circle"><?=$issue->priority;?></span>
                <?=$issue->getPriorityStr();?> (<?=($issue->priority+1);?>%)
            </span>
            <input type="hidden" name="priority" value="<?=$issue->priority;?>"/>
        </li>
        <li>
            <span class="label">Дата создания</span>
            <span class="value"><?=$issue->getCreateDate();?></span>
        </li>
        <li>
            <span class="label">Дата завершения</span>
            <span class="value"><?=$issue->getCompleteDate();?></span>
            <input type="hidden" name="completeDate" value="<?=$issue->getCompleteDate4Input();?>"/>
        </li>
        <li class="issue-completed-date-row">
            <span class="label">Завершена</span>
            <span class="value"><?=$issue->getCompletedDate();?></span>
        </li>
        <li>
            <span class="label">Создал</span>
            <span class="value"><?=$issue->getAuthorLinkedName();?></span>
        </li>
        <li>
            <span class="label">Исполнители</span>
            <span class="value">
                <?php foreach ($issue->getMembers() as $i => $member):
                ?><?=$i>0?',':''
                ?> <?=$member->getLinkedName();?><?php if ($member->sp > 0):
                ?> (<?=$member->sp;?> SP)<?php endif;?><?php
                endforeach;?>
            </span>
            <input type="hidden" name="members" value="<?=$issue->getMemberIdsStr();?>"/>
            <input type="hidden" name="membersSp" value="<?=$issue->getMembersSpStr();?>"/>
        </li>
        <?php $testers = $issue->getTesters(); ?>
        <li  class="testers-row"<?php if (empty($testers)): ?>style="display: none;"<?php endif;?>>
            <span class="label">Тестеры</span>
            <span class="value">
                <?php foreach ($testers as $i => $tester) {?><?=$i>0?', ':''?> <?=$tester->getLinkedName();?><?php }?>
            </span>
            <input type="hidden" name="testers" value="<?=$issue->getTesterIdsStr();?>"/>
        </li>
        <li class="desc">        
            <div class="value"><?=$issue->getDesc();?></div>
        </li>
        <?php if ($videoLinks = $issue->getVideoLinks()): ?>
            <li>
                <ul class="video-line">
                    <?php foreach ($videoLinks as $item): ?>
                        <li>
                            <?php if ($item->type == 'youtube'): ?>
                                <object  width="480" height="320" class="video ytb"
                                    data="<?php echo $item->url; ?>">
                                </object>
                            <?php else: ?>
                                <video width="480" height="320" controls preload class="video dplr">
                                    <source src="<?php echo $item->url; ?>">
                                </video>
                            <?php endif ?>
                        </li>
                    <?php endforeach ?>
                </ul>
            </li>            
        <?php endif ?>
        <?php if ( $picture = $issue->getImages() ): ?>
            <li>
                <ul class="images-line">
                    <?php foreach($picture as $img): ?>
                        <li>
                            <a href="<?=$img->getSource();?>" rel="iLoad|Screenshots"><img src="<?=$img->getPreview();?>"/></a>
                            <input type="hidden" name="imgId" value="<?=$img->imgId;?>">
                        </li>
                    <?endforeach;?>
                </ul>
            </li>
        <?php endif ?>
    </ol>
    <p class="buttons-bar <? switch($issue->status): 
    case 0: ?>active-issue<?break;?> 
    <?case 1: ?>verify-issue<?break;?> 
    <?case 2: ?>completed-issue<?break;?>
    <?endswitch;?>">
        <input type="hidden" name="parentId" value="<?=$issue->parentId;?>"/>
        <input type="hidden" name="issueId" value="<?=$issue->getID();?>"/>      
        <button class="restore-btn" onclick="restoreIssue( event );">Открыть</button>
        <?php if ( $issue->isMember(lpm_get_user()->getID()) ): ?>
        <button class="verify-btn" onclick="verifyIssue( event )">Отправить на проверку</button>
        <?php endif ?>
        <button class="complete-btn" onclick="completeIssue( event );">Завершить</button>
        <button onclick="issuePage.showEditForm();">Редактировать</button> 
        <button onclick="issuePage.removeIssue( event );">Удалить</button>
    </p>
    <a href="<?=lpm_get_base_page_url();?>" class="back-link">Назад</a>
    <a href="<?=$issue->getProjectUrl() . '#copy-issue:' . $issue->idInProject;?>" target="_blank"
       class="copy-issue-link">
        <i class="fa fa-clone" aria-hidden="true" title="Скопировать задачу"></i>
    </a>
    <a href="<?=$issue->getProjectUrl() . '#finished-issue:' . $issue->idInProject;?>" target="_blank"
     class="finished-issue-link">
      <i class="fa fa-plus-square" aria-hidden="true" title="Добавить задачу по доделкам"></i>
    </a>
  </article>
  <article class="comments">
    <div class="links-bar">
        <?php if ($issue->getProject()->scrum):?>
            <div class="scrum-comments-shortcut">
                <a href="#" onclick="issuePage.commentPassTesting(); return false;" title="Прошла тестирование"><i class="far fa-check-square" aria-hidden="true"></i></a>
                <a href="#" onclick="issuePage.commentMergeInDevelop(); return false;" title="Влита в develop"><i class="fas fa-code-branch" aria-hidden="true"></i></a>
            </div>
        <?php endif;?>
        <div class="comments-controls">
            <a href="#" class="toggle-comments" onclick="issuePage.toogleCommentForm(); return false;">Свернуть комментарии</a>
            <a href="#" onclick="issuePage.showCommentForm(); return false;">Добавить комментарий</a>
        </div>
    </div>
    <form class="add-comment" onsubmit="issuePage.postComment(); return false;">
     <textarea name="commentText"></textarea>
     <p class="comment-note">Можете использовать [b], [i], [u], [code] для разметки текста</p>
     <input type="hidden" name="issueId" value="<?=$issue->getID();?>"/>
     <p class="buttons-bar">
        <button type="submit">Отправить</button>
        <button type="reset" onclick="issuePage.hideCommentForm();">Отмена</button>
     </p>
    </form>
    <ol class="comments-list">
        <?php foreach (lpm_get_comments() as $comment): ?>
        <li>
            <p class="href-delete-cookie" data-text='<?=$comment->id;?>' data-cookie="" data-user-id="<?=lpm_get_user()->getID();?>"><?=$_COOKIE['Delete'];?> </p>
            <img src="<?=$comment->getAuthorAvatarUrl();?>" class="user-avatar small"/>
            <p class="author"><?=$comment->getAuthorLinkedName();?></p>
            <p class="date"><a class="anchor" id="comment-<?=$comment->id;?>" href="#comment-<?=$comment->id;?>"><?=$comment->getDate();?></a></p>
            <article class="text"><?=$comment->getText();?></article>
        </li>
        <?php endforeach; ?>
    </ol>
  </article>
</article>
<script type="text/javascript">
    var issueLabels = <?=json_encode($issue->getLabelNames());?>;
</script>
<?php lpm_print_issue_form($issue->getProject(), $issue); ?>