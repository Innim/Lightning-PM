<?php
/* 
Требуются: 
    $issue - текущая задача
    $comments - комментарии к задаче
Необязательные:
    $input - ввод пользователя, который нужно восстановить в форме (нужен в случае ошибки)
*/
$userId = lpm_get_user()->getID();
$isOnBoard = $issue->isOnBoard();

$project = $issue->getProject();

$classes = [];
if ($issue->isTesting()) $classes[] = 'issue-testing';
?>
<article id="issueView" class="mx-auto container container-main px-4 py-4 <?=implode(' ', $classes);?>">
	<div class="col d-flex justify-content-between align-items-center">
		<h1><a href="<?=lpm_get_base_page_url();?>"><?php lpm_print_header();?></a></h1>
        <div class="header-operations-bar row gx-2">
            <div class="col">
                <?php lpm_print_goto_issue($project); ?>
            </div>
            <div class="col">
                <a class="btn btn-outline-primary btn-sm" href="<?=$issue->getProjectUrl('add-issue');?>" role="button" title="Новая задача">
                    <i class="fa-solid fa-plus"></i>
                </a>
            </div>
        </div>
	</div>

    <!-- <p class="header-back-link"><a href="<?=lpm_get_base_page_url();?>" class="back-link">Назад</a></p> -->
    <article id="issueInfo" class="issue-info container-legacy block-with-attachments" data-is-on-board="<?=$isOnBoard ? 1 : 0;?>"
        data-id-in-project="<?=$issue->getIdInProject();?>" data-status="<?=$issue->status;?>"
        data-labels="<?=implode(',', $issue->getLabelNames());?>" data-issue-id="<?=$issue->id;?>">
        <h3>
            <span class="issue-id"><?=$issue->getIdInProject();?></span>.
            <span class="issue-name"><?=$issue->getName();?></span><?php if (($hours = $issue->hours) > 0): ?><span
                class="issues-hours-box">(<span
                    class="issue-hours"><?=$issue->getStrHours();?></span>&nbsp;<?=$issue->getNormHoursLabel(false);?>)</span><?php endif;?>
            <?php if ($project->scrum && !$isOnBoard):?>
            <a href="#" onclick="return issuePage.putStickerOnBoard();" title="Поместить на Scrum доску"
                class="scrum-put-sticker"><i class="fa fa-thumbtack" aria-hidden="true"></i></a>
            <?php endif;?>
        </h3>

        <div class="issue-actions d-flex align-items-center justify-content-end gap-1 mb-3 me-2">
            <a href="javascript:void(0);" 
                onclick="issuePage.onClickCopyIssueUrl(event)" 
                title="Копировать ссылку на задачу"
                data-issue-url="<?=$issue->getConstURL();?>"
                class="me-1 link-secondary">
                <i class="fa fa-link fa-xs" aria-hidden="true"></i>
            </a>
            
            <a href="javascript:void(0);" 
                onclick="issuePage.onClickCopyMarkdownIssueLink(event)" 
                title="Копировать ссылку как Markdown"
                data-issue-url="<?=$issue->getConstURL();?>"
                data-issue-id-in-project="<?=$issue->getIdInProject();?>"
                class="me-1 link-secondary">
                <i class="fa fa-hashtag fa-xs" aria-hidden="true"></i>
            </a>
            
            <div class="dropdown">
                <a href="javascript:void(0);" 
                    class="dropdown-toggle-no-caret" 
                    title="Дополнительные действия"
                    id="issueActionsDropdown" 
                    data-bs-toggle="dropdown" 
                    aria-expanded="false"
                    class="me-1 link-secondary">
                    <i class="fa fa-ellipsis-h fa-xs" aria-hidden="true"></i>
                </a>
                <ul class="dropdown-menu dropdown-menu-end dropdown-menu-sm" aria-labelledby="issueActionsDropdown">
                    <li>
                        <a class="dropdown-item py-1 px-2" 
                            href="javascript:void(0);"
                            onclick="issuePage.onClickCopyIssueName(event)"
                            data-issue-name="<?=addslashes($issue->getName());?>">
                            <i class="fa fa-copy me-1 fa-xs" aria-hidden="true"></i>
                            <small>Копировать название</small>
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item py-1 px-2"
                           href="javascript:void(0);"
                           onclick="issuePage.onClickCopyIssueId(event)"
                           data-issue-id="<?=$issue->getID();?>">
                            <i class="fa fa-wrench me-1 fa-xs" aria-hidden="true"></i>
                            <small>Копировать внутренний ID</small>
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item py-1 px-2" 
                            href="javascript:void(0);"
                            onclick="issuePage.onClickCopyIssueTitle(event)"
                            data-issue-id-in-project="<?=$issue->getIdInProject();?>"
                            data-issue-name="<?=addslashes($issue->getName());?>">
                            <i class="fa fa-heading me-1 fa-xs" aria-hidden="true"></i>
                            <small>Копировать заголовок</small>
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item py-1 px-2" 
                            href="javascript:void(0);"
                            onclick="issuePage.onClickCopyLinkedIssueTitle(event)"
                            data-issue-url="<?=$issue->getConstURL();?>"
                            data-issue-id-in-project="<?=$issue->getIdInProject();?>"
                            data-issue-name="<?=addslashes($issue->getName());?>">
                            <i class="fa fa-arrow-up-right-from-square me-1 fa-xs"></i>
                            <small>Копировать гиперссылку</small>
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item py-1 px-2" 
                            href="javascript:void(0);"
                            onclick="issuePage.onClickCopyChangelogRecord(event)"
                            data-issue-url="<?=$issue->getConstURL();?>"
                            data-issue-id-in-project="<?=$issue->getIdInProject();?>"
                            data-issue-name="<?=addslashes($issue->getName());?>">
                            <i class="fa fa-file-lines me-1 fa-xs" aria-hidden="true"></i>
                            <small>Копировать запись для changelog</small>
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item py-1 px-2" 
                            href="javascript:void(0);"
                            onclick="issuePage.onClickCopyCommitMessage(event)"
                            data-issue-id-in-project="<?=$issue->getIdInProject();?>"
                            data-issue-name="<?=addslashes($issue->getName());?>">
                            <i class="fa fa-code-commit me-1 fa-xs" aria-hidden="true"></i>
                            <small>Копировать commit сообщение</small>
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item py-1 px-2"
                           href="javascript:void(0);"
                           onclick="issuePage.onClickCopyIssueForAI(event)"
                           data-issue-url="<?=$issue->getConstURL();?>"
                           data-issue-id-in-project="<?=$issue->getIdInProject();?>"
                           data-issue-name="<?=addslashes($issue->getName());?>">
                            <i class="fa fa-robot me-1 fa-xs" aria-hidden="true"></i>
                            <small>Копировать для AI</small>
                        </a>
                    </li>
                </ul>
            </div>
        </div>

        <div class="info-list <?switch($issue->status): 
    case 0: ?>active-issue <?break;?> 
    <? case 1: ?>verify-issue <?break;?> 
    <?case 2: ?>completed-issue<?break;?>
    <?endswitch;?> mx-4">
            <div class="info-list-item">
                <span class="label">Статус</span>
                <span class="value"><?=$issue->getStatus();?></span>
            </div>
            <div class="info-list-item">
                <span class="label">Тип</span>
                <span class="value"><?=$issue->getType();?></span>
                <input type="hidden" name="type" value="<?=$issue->type;?>" />
            </div>
            <div class="info-list-item">
                <span class="label">Приоритет</span>
                <span class="value">
                    <span class="priority-val circle"><?=$issue->getPriorityDisplayValue();?></span>
                    <?=$issue->getPriorityStr();?> (<?=($issue->getPriorityDisplayValue());?>%)
                </span>
                <input type="hidden" name="priority" value="<?=$issue->priority;?>" />
            </div>
            <div class="info-list-item">
                <span class="label">Дата создания</span>
                <span class="value"><?=$issue->getCreateDate();?></span>
            </div>
            <div class="issue-complete-date-row info-list-item <?=$issue->hasCompleteDate() ? '' : 'no-date';?>">
                <span class="label">Дата завершения</span>
                <span class="value"><?=$issue->getCompleteDate();?></span>
                <input type="hidden" name="completeDate" value="<?=$issue->getCompleteDate4Input();?>" />
            </div>
            <div class="issue-completed-date-row info-list-item">
                <span class="label">Завершена</span>
                <span class="value"><?=$issue->getCompletedDate();?></span>
            </div>
            <div class="info-list-item">
                <span class="label">Создал</span>
                <span class="value"><?=$issue->getAuthorLinkedName();?></span>
            </div>
            <div class="info-list-item">
                <span class="label">Исполнители</span>
                <span class="value">
                    <?php if ($issue->hasMembers()):?>
                    <?php foreach ($issue->getMembers() as $i => $member):
                ?><?=$i>0?',':''
                ?> <?=$member->getLinkedName();?><?php if ($member->sp > 0):
                ?> (<?=$member->sp;?> SP)<?php endif;?><?php
                endforeach;?>
                    <?php else: ?>
                    Не назначены
                    <?php endif; ?>
                </span>
                <input type="hidden" name="members" value="<?=$issue->getMemberIdsStr();?>" />
                <input type="hidden" name="membersSp" value="<?=$issue->getMembersSpStr();?>" />
            </div>
            <?php $testers = $issue->getTesters(); ?>
            <div class="testers-row info-list-item" <?php if (empty($testers)): ?>style="display: none;" <?php endif;?>>
                <span class="label">Тестеры</span>
                <span class="value">
                    <?php foreach ($testers as $i => $tester) {?><?=$i>0?', ':''?>
                    <?=$tester->getLinkedName();?><?php }?>
                </span>
                <input type="hidden" name="testers" value="<?=$issue->getTesterIdsStr();?>" />
            </div>
            <?php $masters = $issue->getMasters(); ?>
            <div class="masters-row info-list-item" <?php if (empty($masters)): ?>style="display: none;" <?php endif;?>>
                <span class="label">Мастеры</span>
                <span class="value">
                    <?php foreach ($masters as $i => $master) {?><?=$i>0?', ':''?>
                    <?=$master->getLinkedName();?><?php }?>
                </span>
                <input type="hidden" name="masters" value="<?=$issue->getMasterIdsStr();?>" />
            </div>
            <div class="desc info-list-item">
                <div class="value formatted-desc text-with-attachments"><?=$issue->getDesc();?></div>
                <textarea class="raw-desc" style="display: none;"><?=$issue->desc;?></textarea>
            </div>
            <div class="info-list-item attachments"></div>
            <?php
            // Render previews for uploaded video files before images
            $videoFiles = [];
            $filesForPreview = $issue->getFiles();
            if (!empty($filesForPreview)) {
                foreach ($filesForPreview as $file) {
                    if ($file->isVideo()) {
                        $videoFiles[] = (object) [
                            'type' => 'video',
                            'url'  => $file->getDownloadUrl(),
                        ];
                    }
                }
            }
            if (!empty($videoFiles)):
            ?>
            <div class="info-list-item">
                <?php lpm_print_video_list($videoFiles); ?>
            </div>
            <?php endif; ?>
            <?php if ($picture = $issue->getImages()): ?>
            <div class="info-list-item">
                <ul class="images-line">
                    <?php foreach ($picture as $img): ?>
                    <li>
                        <a href="<?=$img->getSource();?>" class="image-link" rel="iLoad|Screenshots"><img
                                src="<?=$img->getPreview();?>" class="image-preview border border-1 rounded-3" /></a>
                        <input type="hidden" name="imgId" value="<?=$img->imgId;?>">
                    </li>
                    <?endforeach;?>
                </ul>
            </div>
            <?php endif; ?>
        </div>

        <?php $files = $issue->getFiles(); ?>
        <?php if (!empty($files)): ?>
        <div class="info-list-item files-row mx-4 mt-4">
            <h6 class="label mb-3">Файлы</h6>
            <div class="value w-100">
                <ul class="issue-files-list list-group list-group-flush mb-4">
                    <?php foreach ($files as $file): ?>
                    <li class="issue-file-item list-group-item d-flex align-items-center justify-content-between gap-3">
                        <div class="d-flex align-items-start gap-3">
                            <span class="text-secondary pt-1"><i class="fas fa-paperclip"></i></span>
                            <div class="d-flex flex-column">
                                <a href="<?=$file->getDownloadUrl();?>" class="issue-file-link fw-semibold" target="_blank" rel="noopener" download="<?=$file->origName;?>">
                                    <span class="file-name"><?=$file->origName;?></span>
                                </a>
                                <span class="text-muted small issue-file-size"><?=FileSizeFormatter::format($file->size);?></span>
                            </div>
                        </div>
                        <div class="ms-auto">
                            <a href="<?=$file->getDownloadUrl();?>" class="btn btn-outline-secondary btn-sm" target="_blank" rel="noopener" download="<?=$file->origName;?>">
                                <i class="fas fa-download me-1"></i>Скачать
                            </a>
                        </div>
                        <input type="hidden" name="fileId" class="issue-file-id-input" value="<?=$file->fileId;?>">
                    </li>
                    <?php endforeach; ?>
                </ul>
            </div>
        </div>
        <?php endif; ?>

        <hr class="text-secondary opacity-50 my-4">    

        <?php
            $linkedIssues = $issue->getLinkedIssues();
            if (!empty($linkedIssues)):
        ?>
        <div id="linkedIssues" class="linked-issues mx-4">
            <div class="card text-dark bg-light mb-3">
                <div class="card-header">Связанные задачи</div>
                <div class="card-body"><?php foreach ($linkedIssues as $item): ?>
                    <div class="linked-issue-item card-text">
                        <a href="<?=$item->getConstURL();?>">
                            <?php if ($item->projectId != $issue->projectId):?>
                            <span class="linked-issue-project"><?=$item->getProject()->name;?></span>:
                            <?php endif;?>
                            <?=$item->getIdInProject();?>. <?=$item->getName();?>
                        </a>
                    </div>
                    <?php endforeach; ?>
                </div>
            </div>
        </div>
        <?php endif;?>
        <p class="buttons-bar my-4 <? switch($issue->status): 
    case 0: ?>active-issue<?break;?> 
    <?case 1: ?>verify-issue<?break;?> 
    <?case 2: ?>completed-issue<?break;?>
    <?endswitch;?>">
            <input type="hidden" name="issueId" value="<?=$issue->getID();?>" />
            <input type="hidden" name="revision" value="<?=$issue->revision;?>" />
            <button class="btn btn-secondary restore-btn" onclick="restoreIssue(event);">Открыть</button>
            <?php if ($issue->isMember($userId) || $issue->isMaster($userId, true)): ?>
            <button class="btn btn-primary verify-btn" onclick="verifyIssue(event)">Отправить на проверку</button>
            <?php endif ?>
            <button class="btn btn-success complete-btn" onclick="completeIssue(event);">Завершить</button>
            <button class="btn btn-primary" onclick="issuePage.showEditForm();">Редактировать</button>
            <button class="btn btn-danger" onclick="issuePage.removeIssue(event);">Удалить</button>
        </p>
        <a href="<?=lpm_get_base_page_url();?>" class="back-link">Назад</a>
        <a href="#" onclick="issuePage.copyIssue(); return false;" class="copy-issue-link">
            <i class="fa fa-clone" aria-hidden="true" title="Скопировать задачу"></i>
        </a>
        <a href="#" onclick="issuePage.finishedIssue(); return false;" class="finished-issue-link">
            <i class="fa fa-plus-square" aria-hidden="true" title="Добавить связанную задачу"></i>
        </a>
    </article>
    <article id="comments" class="comments px-4">
        <div class="links-bar">
            <?php if ($project->scrum):?>
            <div class="scrum-comments-shortcut">
                <?php if ($project->isIntegratedWithGitlab()): ?>
                <a href="#" class="create-branch-icon" onclick="issuePage.createBranch(); return false;"
                    title="Создать ветку для задачи">
                    <i class="fas fa-code-branch branch-icon" aria-hidden="true"></i><i
                        class="fas fa-plus plus-icon"></i>
                </a>
                <?php endif; ?>
                <a href="#" onclick="issuePage.commentPassTesting(); return false;" title="Прошла тестирование"><i
                        class="far fa-check-square" aria-hidden="true"></i></a>
                <a href="#" onclick="issuePage.commentMergeInDevelop(); return false;" title="Влита в develop"><i
                        class="fas fa-code-merge" aria-hidden="true"></i></a>
            </div>
            <?php endif;?>
            <div class="comments-controls">
                <a href="#" class="toggle-comments" onclick="comments.toggleCommentForm(); return false;">Свернуть
                    комментарии</a>
                <a href="#" onclick="comments.showCommentForm(); return false;">Добавить комментарий</a>
                <a href="#" class="request-changes-link text-danger" onclick="comments.showCommentForm(true); return false;"><i class="fas fa-bug changes-requested-check"></i> Найдены проблемы</a>
            </div>
        </div>
        <form id="addCommentForm" class="add-comment" onsubmit="issuePage.postComment(); return false;">
            <?php lpm_print_comment_input_text('addCommentTabs');?>

            <input type="hidden" name="issueId" value="<?=$issue->getID();?>" />

            <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-2 align-items-center">
                <div class="form-check form-check-inline" >
                    <input class="form-check-input" name="requestChanges" type="checkbox" value="" id="requestChangesCheckbox">
                    <label class="form-check-label" for="requestChangesCheckbox">
                        <i class="fas fa-bug changes-requested-check"></i>
                        Найдены проблемы
                    </label>
                </div>
                
                <button class="btn btn-primary" type="submit">Отправить</button>
                <button class="btn btn-secondary" type="reset" onclick="comments.hideCommentForm();">Отмена</button>
            </div>
        </form>
        <section class="comments-list">
            <?php foreach ($comments as $comment): ?>
            <div class="comments-list-item">
                <?php lpm_print_comment($comment);?>
            </div>
            <?php endforeach; ?>
        </section>
        <input id='is-admin' type="hidden" value="<?=lpm_get_user()->isAdmin();?>">
    </article>
</article>
<input id='user-id-hidden' type="hidden" value="<?=$userId;?>">
<?php
$labelsJson = json_encode($issue -> getLabelNames());
echo <<<HTML
<script type="text/javascript">
    var issueLabels = $labelsJson;
</script>
HTML;
?>
<?php lpm_print_issue_form($project, $issue, isset($input) ? $input : null, true); ?>

<div class="modal fade" id="createBranch" tabindex="-1" aria-labelledby="createBranchLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="createBranchLabel">Создать ветку задачи</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="createBranchForm" class="create-branch" onsubmit="createBranch.save(); return false;">
            <div class="mb-3">
                <label for="repository" class="form-label">Репозиторий</label>
                <select class="form-select" id="repository" name="repository"></select>
            </div>
            <div class="mb-3">
                <label for="parentBranch" class="form-label">Из</label>
                <select class="form-select" id="parentBranch" name="parentBranch"></select>
            </div>
            <div class="mb-3">
                <label for="branchName" class="form-label">Название</label>
                <input type="text" class="form-control" id="branchName" name="branchName">
            </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
        <button type="submit" class="btn btn-primary" form="createBranchForm">Создать</button>
      </div>
    </div>
  </div>
</div>

<article id="passTestDialog" title="Прошла тестирование">
    <form class="pass-test">
        <ul class="pass-test-items">
            <li>
                <label>Введите дополнительную информацию, если нужно</label>
                <?php lpm_print_comment_input_text('passTestComment');?>
            </li>
        </ul>
    </form>
</article>

<!-- Merge In Develop Confirm Modal -->
<div class="modal fade" id="mergeInDevelopConfirmModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Завершить задачу?</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
      </div>
      <div class="modal-body">
        <div class="d-flex align-items-start">
          <i class="fas fa-triangle-exclamation text-warning me-2 mt-1" aria-hidden="true"></i>
          <div>Добавляется отметка о влитии в develop. Хотите также завершить задачу?</div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-action="cancel">Отмена</button>
        <button type="button" class="btn btn-warning" data-action="no">Нет</button>
        <button type="button" class="btn btn-primary" data-action="yes">Да</button>
      </div>
    </div>
  </div>
</div>

<!-- Create From Issue (Copy) Modal -->
<div class="modal fade" id="createFromIssueCopyModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Создать копию задачи</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="createFromIssueProjectCopy" class="form-label">Создать задачу в</label>
          <select class="form-select" id="createFromIssueProjectCopy"></select>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="checkbox" value="" id="createFromIssueCopyLinks">
          <label class="form-check-label" for="createFromIssueCopyLinks">Копировать связи</label>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-action="cancel">Отмена</button>
        <button type="button" class="btn btn-primary" data-action="continue">Продолжить</button>
      </div>
    </div>
  </div>
  </div>

<!-- Create From Issue (Follow-up) Modal -->
<div class="modal fade" id="createFromIssueFinishedModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Добавить связанную задачу</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="createFromIssueProjectFinished" class="form-label">Создать задачу в</label>
          <select class="form-select" id="createFromIssueProjectFinished"></select>
        </div>
        <div class="mb-3">
          <label for="createFromIssueTargetKind" class="form-label">Тип задачи</label>
          <select class="form-select" id="createFromIssueTargetKind">
            <option value="apply">Реализация в другом проекте</option>
            <option value="finished">Доработки</option>
            <option value="related-copy">Связанная копия</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-action="cancel">Отмена</button>
        <button type="button" class="btn btn-primary" data-action="continue">Продолжить</button>
      </div>
    </div>
  </div>
</div>
